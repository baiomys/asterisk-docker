[globals]
SCRIPTS=/etc/asterisk/scripts
TTOKEN=
;;T2
TCHAT=

[general]
autofallthrough=yes

[ussd]
exten => ussd,1,Noop(Incoming USSD: ${BASE64_DECODE(${USSD_BASE64})})
exten => ussd,n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${DONGLENAME}: ${BASE64_DECODE(${USSD_BASE64})}' >> /var/log/asterisk/ussd.txt)
exten => ussd,n,Hangup()

[svc-codes]
;; ================ DND
;; toggle
exten => *76,1,Answer
same  => n,ExecIf($["${DB(DND/${CALLERID(number)})}" != "1"]?Gosub(svc-on-off,dnd-on,1()):Gosub(svc-on-off,dnd-off,1()))
same  => n,ExecIf($["${DB(DND/${CALLERID(number)})}" = "1"]?Playback(do-not-disturb&activated):Playback(do-not-disturb&de-activated))
same  => n,Hangup

;; activate
exten => *78,1,Gosub(svc-on-off,dnd-on,1())
same  => n,ExecIf($["${DB(DND/${CALLERID(number)})}" = "1"]?Playback(do-not-disturb&activated):Playback(do-not-disturb&de-activated))
same  => n,Hangup

;; deactivate
exten => *79,1,Gosub(svc-on-off,dnd-off,1())
same  => n,ExecIf($["${DB(DND/${CALLERID(number)})}" = "1"]?Playback(do-not-disturb&activated):Playback(do-not-disturb&de-activated))
same  => n,Hangup

;; ================ SPAM BLOCK
;; toggle
exten => *56,1,Answer

same  => n,ExecIf(${DB_EXISTS(SPM/${CALLERID(number)})}?Gosub(svc-on-off,blk-on,1()):Gosub(svc-on-off,blk-off,1()))
same  => n,ExecIf(${DB_EXISTS(SPM/${CALLERID(number)})}?Playback(vm-youhave&de-activated):Playback(vm-youhave&activated))
same  => n,Hangup

;; activate
exten => *58,1,Gosub(svc-on-off,blk-on,1())
same  => n,ExecIf(${DB_EXISTS(SPM/${CALLERID(number)})}?Playback(vm-youhave&de-activated):Playback(vm-youhave&activated))
same  => n,Hangup

;; deactivate
exten => *59,1,Gosub(svc-on-off,blk-off,1())
same  => n,ExecIf(${DB_EXISTS(SPM/${CALLERID(number)})}?Playback(vm-youhave&de-activated):Playback(vm-youhave&activated))
same  => n,Hangup

[svc-on-off]
exten => dnd-on,1,NoOp(DND HANDLING)
same  => n,Set(DB(DND/${CALLERID(number)})=1)
same  => n,Set(STATE=RINGING)
same  => n,Set(DEVICE_STATE(Custom:DND${CALLERID(number)})=${STATE})
same  => n,Return

exten => dnd-off,1,NoOp(DND HANDLING)
same  => n,Set(DB(DND/${CALLERID(number)})=0)
same  => n,Set(STATE=NOT_INUSE)
same  => n,Set(DEVICE_STATE(Custom:DND${CALLERID(number)})=${STATE})
same  => n,Return

exten => blk-on,1,NoOp(SPAM CHECK HANDLING)
same  => n,Set(_R=${DB_DELETE(SPM/${CALLERID(number)})})
same  => n,Return

exten => blk-off,1,NoOp(SPAM CHECK HANDLING)
same  => n,Set(DB(SPM/${CALLERID(number)})="OFF")
same  => n,Return

[radio]
exten => *77,1,Answer
same  => n,MP3Player(http://retro80.hostingradio.ru:8025/retro80-128.mp3)
;;same  => n,MusicOnHold(radio)
same  => n,Hangup

exten => *88,1,Answer
same  => n,MP3Player(http://retro90.hostingradio.ru:8025/retro90-128.mp3)
;;same  => n,MusicOnHold()
same  => n,Hangup

exten => *99,1,Answer
same  => n,MusicOnHold()
same  => n,Hangup

[dialout]
exten => s,1,NooP(DIAL,${CALLERID(num)},${CALLERID(name)},${ARG1})

; check if personal number exists
same => n,GotoIf($["${DEVICE_STATE(PJSIP/FXO-${CALLERID(NUM)})}"!="NOT_INUSE"]?use_common)
same => n,set(LIMIT_WARNING_FILE=beep)
same => n,set(LIMIT_TIMEOUT_FILE=thank-you-for-calling)
same => n,set(LIMIT_PLAYAUDIO_CALLER=yes)
same => n,Dial(PJSIP/${ARG1}@FXO-${CALLERID(NUM)},30,L(420000:300000:30000))
same => n,Hangup()

;; ================
same => n(use_common),NoOp()
; test
same => n,ExecIf($["${CALLERID(num)}" = "111"]?Dial(PJSIP/$2{ARG1}@APCp2)
same => n,ExecIf($["${CALLERID(num):0:1}" = "4"]?Goto(hbr):Goto(zoo)

same => n(zoo),Noop()
same => n,Dial(PJSIP/${ARG1}@FXO-Z2,30,L(420000:300000:30000))
same => n,Dial(PJSIP/${ARG1}@FXO-Z1,30,L(420000:300000:30000))
same => n,Playtones(busy)
same => n,Congestion
same => n,Hangup()
;; ================
same => n(hbr),Dial(PJSIP/4${ARG1}@APCp4)
same => n,Hangup()

[out]
exten => 112,1,Gosub(dialout,s,1(${EXTEN}))
exten => _+79XXXXXXXXX,1,Goto(8${EXTEN:2},1)
exten => _[2346]XXXXX,1,Gosub(dialout,s,1(88182${EXTEN}))

;; ==== check for indirect local call
exten => _89XXXXXXXXX,1,NooP(OUT,${CALLERID(NUM)},${EXTEN})
same  => n,ExecIf($[${DB_EXISTS(fxolist/DP/7${EXTEN:1})} != 1]?Gosub(dialout,s,1(${EXTEN})))
;;same  => n,Hangup()
same  => n,Dial(${DB(fxolist/DP/7${EXTEN:1})},20,Tt))
same  => n,Hangup()

[out-810]
exten => _8[2-8]XXXXXXXXX,1,Gosub(dialout,s,1(${EXTEN}))
exten => _810.,1,Gosub(dialout,s,1(${EXTEN}))

[hbr-in]
exten => IVR,1,NooP()

same => n,GotoIfTime(20:00-10:00,mon-sun,*,*?voicemail)
;same => n,Goto(voicemail)

;spam check
;;same  => n,Set(CALLERID(num)=89676547582)
;; if key exists then bypass spam check
same  => n,ExecIf($[${DB_EXISTS(SPM/415)} != 1]?Gosub(BLK,start,1))
;;same  => n,Dial(PJSIP/415&PJSIP/402,25,t)
same  => n,Dial(PJSIP/415,25,t)
same  => n,Hangup()

same => n(voicemail),Answer(500)

;same  => n,Playback(ivr/hbr/HBRv1&ivr/hbr/v1)
same  => n,Playback(ivr/hbr/HBRv2&ivr/hbr/v2)
;same  => n,Playback(ivr/hbr/giftv1&ivr/hbr/v1)
;same  => n,Playback(ivr/hbr/giftv2&ivr/hbr/v2)

same => n,VoiceMail(HBR@telega,s)
;same => n,VoiceMail(111@telega,s)
same => n,Hangup()

[zoo-in]
exten => IVR,1,NoOp()
same => n,NooP(IVR,${CALLERID(num)},${CALLERID(name)})

;same  => n,GotoIF($["${CALLERID(num)}" != "89115601202"]?bypass)
;;same  => n,GotoIF($["${CALLERID(num)}" != "89214857388"]?bypass)

same => n(bypass),Set(TIMEOUT(digit)=4)
same => n,Set(TIMEOUT(response)=5)
same => n,Answer(500)

;;same => n(start),Read(Code,ivr/zoo/1&ivr/zoo/2,3,,1,5)
same => n(start),Read(Code,ivr/zoo/1&ivr/zoo/2,3,,1,7)
same => n,NoOp(${Code})

same => n,ExecIf($[${READSTATUS}=TIMEOUT]?Goto(ASSIST,1))
same => n,ExecIf($[${READSTATUS}!=OK]?Goto(ERR,1))
same => n,ExecIf($["${Code}"="000"]?MP3Player(http://retro80.hostingradio.ru:8025/retro80-128.mp3))

same => n,ExecIf($["${DEVICE_STATE(PJSIP/${Code})}" = "INVALID"]?Goto(ERR,1))

same => n,ExecIf($["${Code:0:1}"="3"]?Goto(CALL,1))
same => n,ExecIf($["${Code:0:1}"="4"]?Goto(CALL,1))

; ===== IS PRIVELEGED NUMBER?
;;same => n,ExecIf($[${DB_EXISTS(wlist/${CALLERID(num)})} != 1]?Goto(ERR,1))
same => n,ExecIf($["${Code:0:1}"="1"]?Goto(CALL,1)

; ===== NO OPTIONS LEFT
same => n,Goto(ERR,1)
same => n(end),Hangup()

; ======= ERROR
exten => ERR,1,NooP()
same => n,Playback(ivr/zoo/err)
same => n,Goto(IVR,start)

; ======= OPERATOR
exten => ASSIST,1,NooP()
same => n,ExecIfTime(10:00-20:00,mon-sun,*,*?Dial(PJSIP/315,20,t))
same => n,Playback(vm-nobodyavail)
same => n,Hangup

; ======= EXTENSION
exten => CALL,1,NooP()
same => n,ExecIf($["${DB(DND/${Code})}" != "1"]?Dial(PJSIP/${Code},20,t))
same => n,Playback(vm-nobodyavail)
same => n,Hangup

[from-hshop]
include => out
include => radio

;;check DND
;;exten => 400,1,Dial(Local/VM@hbr-in)
exten => 400,1,Dial(Local/IVR@hbr-in)
exten => 300,1,Dial(Local/IVR@zoo-in)
exten => _[1234]XX,1,ExecIf($["${DB(DND/${EXTEN})}" != "1"]?Dial(PJSIP/${EXTEN},20,Tt))
same  => n,Hangup()

[from-zshop]
include => out
include => radio

;;exten => 555,1,Dial(Dongle/GSM_B/89027007388,20,Tt)
exten => 400,1,Dial(Local/IVR@hbr-in)
exten => 300,1,Dial(Local/IVR@zoo-in)

exten => 911,1,Dial(PJSIP/+88805413333@tg2sip,40)
exten => 555,1,Dial(PJSIP/+79052900000@tg2sip,40)

;;check DND
exten => _[1234]XX,1,ExecIf($["${DB(DND/${EXTEN})}" != "1"]?Dial(PJSIP/${EXTEN},20,Tt))
same  => n,Hangup()

[from-zo]
include => from-zshop
include => svc-codes
include => out-810

[from-ho]
include => from-hshop
include => svc-codes
include => out-810

[from-corax]
include => zoo-in
include => hbr-in
exten => _[1234]XX,1,ExecIf($["${DB(DND/${EXTEN})}" != "1"]?Dial(PJSIP/${EXTEN},20,Tt))


[telegram]
exten => sound,1,Set(a=${CURL(https://api.telegram.org/bot${TTOKEN}/sendMessage,chat_id=${CHAT}&text=${MSG})})}
same  => n,Return()
;;silent messaging
exten => silent,1,Set(a=${CURL(https://api.telegram.org/bot${TTOKEN}/sendMessage,chat_id=${CHAT}&text=${MSG}&disable_notification=true)})}
same  => n,Return()

[sms]
;; -------------- INCOMING SMS
exten => sms,1,Noop(SMS,${DONGLENAME} )

;; --- decode and log
same => n,Set(CONTENT=${BASE64_DECODE(${SMS_BASE64})})
same => n,Set(MSG=[${DONGLENAME}] ${CALLERID(num)}: ${CONTENT})
same => n,System(echo '${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${MSG}' >> /tmp/sms.txt)

;; --- spam check
;;same => n,Gosub(sms-spam-check,start,1)

;; --- get telegram credentials for sender
same => n,ExecIf($[${DB_EXISTS(smsid/${DONGLENAME})} = 0]?Goto(viasip))
same => n,Set(TGC=${DB(smsid/${DONGLENAME})})
same => n,Set(TTOKEN=${CUT(TGC,~,1)})
same  => n,ExecIf($[${DB_EXISTS(bankid/${CALLERID(num)})} = 1]?Set(CHAT=${CUT(TGC,~,3)}):Set(CHAT=${CUT(TGC,~,2)}))
same  => n,Gosub(telegram,sound,1)
same  => n,Hangup()

same  => n(viasip),Noop(VIASIP)
same  => n,Set(MESSAGE(from)=${CALLERID(num)})
same  => n,Set(MESSAGE(to)=${CUT(CONTENT,:,1):0:3})
same  => n,Set(MESSAGE(body)=${CUT(CONTENT,:,2-)})
same  => n,NooP(${MESSAGE(from)},${MESSAGE(to)},${MESSAGE(body)})
same  => n,ExecIf($["${REGEX("^[0-9]" ${MESSAGE(to)})}" = "1"]?MessageSend(pjsip:${MESSAGE(to)},${MESSAGE(from)}))
same  => n,Hangup()

exten => report,1,NooP(SMS)
same  => n,Hangup()

[BLK]
exten => start,1,NooP(SPAMBLK)

;;;same  => n,Set(CALLERID(num)=89670000000)

same  => n(check),Set(CURLOPT(httptimeout)=2)

same  => n,Set(RES=${CURL(https://cg29.ru/spmchk?7${CALLERID(num):1})})
same  => n,GotoIf($["${RES}"="1"]?spam)
same  => n,Return

same  => n(spam),Set(CALLERID(name)=${CALLERID(name)}_SPAM)
same  => n,Zapateller(answer)
same  => n,Hangup

[CLID]
exten => start,1,NooP(CLID,${CALLERID(num)})
same  => n,ExecIf($["${CALLERID(num):0:1}" = "7"]?Set(CALLERID(num)=8${CALLERID(num):1}))
same  => n,ExecIf($["${CALLERID(num):0:2}" = "+7"]?Set(CALLERID(num)=8${CALLERID(num):2}))
same  => n,ExecIf($["${CALLERID(num):0:3}" = "007"]?Set(CALLERID(num)=8${CALLERID(num):3}))

same  => n,Return()

[ban]
exten => init,1,Set(__DYNAMIC_FEATURES=ban)
same => n,Return()

exten => start,1,Noop()
same  => n,Set(DB(blacklist/${CONNECTEDLINE(num)})=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} by ${CALLERID(num)})
same  => n,Playback(vm-saved)
same  => n,Return()

[from-gsm]
include => sms
include => ussd

;;exten => 79210000000,1,Goto(zoo-in,IVR,1)
;;exten => 79210000001,1,Goto(zoo-in,IVR,1)
;;same  => n,Hangup()

[from-megafon]
;exten => 792100000002,1,Noop(common,${CHANNEL(endpoint)},${CALLERID(num)})
;same  => n,Dial(PJSIP/211,25,tb(ban^init^1)))
;same  => n,Playback(vm-nobodyavail)
;same  => n,Hangup()

; HBR IVR
exten => _795200000001,1,Noop(common,${CHANNEL(endpoint)},${CALLERID(num)})
same  => n,Set(CALLERID(name)=${CHANNEL(endpoint)})
same  => n,Gosub(CLID,start,1)
same  => n,Goto(hbr-in,IVR,1)
same  => n,Hangup()

; CHP IVR
exten => _7921XXX2727,1,Noop(common,${CHANNEL(endpoint)},${CALLERID(num)})
same  => n,Set(CALLERID(name)=${CHANNEL(endpoint)})
same  => n,Gosub(CLID,start,1)
same  => n,Gosub(BLK,start,1)
same  => n,Goto(zoo-in,IVR,1)
same  => n,Hangup()

exten => _7.,1,ExecIf($[${DB_EXISTS(fxolist/DP/${EXTEN})} != 1]?Hangup()
same  => n,Set(CALLERID(name)=${CHANNEL(endpoint)})
;; normalize number and spam check
same  => n,Gosub(CLID,start,1)
same  => n,Gosub(BLK,start,1)
same  => n,ExecIf($[${BLACKLIST()}=1]?Hangup())
same  => n,Set(TARGET=${DB(fxolist/DP/${EXTEN})})
same  => n,NooP(State,${DEVICE_STATE(${TARGET})})
;;same  => n,ExecIf($["${DEVICE_STATE(${TARGET})}"="UNAVAILABLE"]?Playback(vm-nobodyavail):Dial(${TARGET},25,tb(ban^init^1)))
same  => n,ExecIf($["${DEVICE_STATE(${TARGET})}"="UNAVAILABLE"]?Playback(vm-nobodyavail):Dial(${TARGET},25,t))
same  => n,Hangup()
